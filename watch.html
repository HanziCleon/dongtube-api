<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="pageTitle">Watch Anime - DongTube</title>
<link rel="icon" type="image/png" href="https://b.top4top.io/p_35449hn0x0.jpg">
<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<meta name="description" id="pageDescription" content="Watch anime episodes in HD quality with subtitles on DongTube">
<meta property="og:title" id="ogTitle" content="Watch Anime - DongTube">
<meta property="og:description" id="ogDescription" content="Stream anime episodes in HD quality">
<meta property="og:image" id="ogImage" content="">
<meta property="og:url" id="ogUrl" content="">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="watch-page">

<!-- Background Animation -->
<div class="bg-animation">
  <div class="floating-orb orb-1"></div>
  <div class="floating-orb orb-2"></div>
</div>

<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-brand">
      <a href="/home" class="brand-link">
        <span class="brand-icon">üé¨</span>
        <span class="brand-text">DongTube</span>
      </a>
    </div>
    <div class="nav-center">
      <h1 id="animeTitle" class="nav-title">Loading...</h1>
    </div>
    <div class="nav-actions">
      <button id="themeSwitcher" class="nav-btn" title="Switch Theme">üåô</button>
    </div>
  </div>
</nav>

<div class="container">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb" id="breadcrumb">
    <a href="/home" class="breadcrumb-link">Home</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <a href="#" id="animeBreadcrumb" class="breadcrumb-link">Anime</a>
    <span class="breadcrumb-separator">‚Ä∫</span>
    <span id="episodeBreadcrumb">Episode</span>
  </nav>

  <!-- Now Playing Header -->
  <div class="now-playing">
    <div class="now-playing-info">
      <span class="live-badge">üî¥ WATCHING</span>
      <h2 id="nowPlaying">Episode 1</h2>
    </div>
  </div>

  <!-- Main Content Layout -->
  <div class="watch-layout">
    <!-- Video Player Section -->
    <div class="player-section">
      <div class="player-container">
        <div class="player-wrapper">
          <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen allow="autoplay; encrypted-media" title="Anime Video Player"></iframe>
          <div class="player-loading" id="playerLoading">
            <div class="spinner"></div>
            <span>Loading episode...</span>
          </div>
        </div>
        
        <!-- Player Controls -->
        <div class="player-controls">
          <div class="control-left">
            <span class="quality-badge">HD</span>
            <span class="sub-badge">SUB</span>
          </div>
          <div class="control-center">
            <div class="episode-nav-inline">
              <button id="prevEp" class="nav-btn-inline">‚èÆÔ∏è Previous</button>
              <button id="nextEp" class="nav-btn-inline">Next ‚è≠Ô∏è</button>
            </div>
          </div>
          <div class="control-right">
            <button class="control-btn" id="favoriteBtn" title="Add to Favorites">‚ù§Ô∏è</button>
            <button class="control-btn" id="shareBtn" title="Share">üì§</button>
            <button class="control-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Anime Info -->
      <div class="anime-info-card">
        <h3 class="card-header">Anime Info</h3>
        <div id="animeDetails" class="anime-details">
          <div class="details-loading">
            <div class="skeleton-img"></div>
            <div class="skeleton-text"></div>
            <div class="skeleton-text short"></div>
          </div>
        </div>
      </div>

      <!-- Episodes Section -->
      <div class="episodes-card">
        <div class="card-header-with-count">
          <h3 class="card-header">Episodes <span id="episodeCount">(0)</span></h3>
        </div>
        
        <div class="episode-container">
          <div id="episodes" class="episode-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Anime Section -->
  <section class="related-section">
    <h3 class="section-title">Related Anime</h3>
    <div id="relatedAnime" class="related-grid"></div>
  </section>
</div>

<!-- Footer -->
<footer class="footer compact">
  <div class="footer-content">
    <span>&copy; 2025 DongTube</span>
    <a href="/home" class="back-link">‚Üê Back to Home</a>
  </div>
</footer>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
// JSONBin Configuration
const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68c7fdc9d0ea881f407e85cc";
const JSONBIN_KEY = "$2a$10$PsVzgljojE5fq8qZRmpE4uzMr0K9LArqfmumGVSmNY.P8F2iTKrim";

// Global variables
let animeData = [];
let currentAnime = null;
let currentEpisodeIndex = 0;

// Theme Management
class ThemeManager {
  constructor() {
    this.currentTheme = localStorage.getItem('dongtube_theme') || 'dark';
    this.init();
  }

  init() {
    this.applyTheme(this.currentTheme);
    this.bindEvents();
  }

  applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const themeIcon = document.querySelector('#themeSwitcher');
    if (themeIcon) {
      themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    this.currentTheme = theme;
    localStorage.setItem('dongtube_theme', theme);
  }

  toggle() {
    const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
    this.applyTheme(newTheme);
    this.showToast(`Switched to ${newTheme} theme`, 'success');
  }

  bindEvents() {
    const themeSwitcher = document.getElementById('themeSwitcher');
    if (themeSwitcher) {
      themeSwitcher.addEventListener('click', () => this.toggle());
    }
  }

  showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') || this.createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 300);
    }, 3000);
  }

  createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
    return container;
  }
}

// URL Helper Functions
function createStreamingUrl(anime, episode = null) {
  const baseUrl = window.location.origin;
  let slug = anime.title
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
  
  return `${baseUrl}/streaming-${slug}`;
}

function parseUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  const pathMatch = window.location.pathname.match(/\/streaming-(.+)/);
  return {
    id: parseInt(urlParams.get('id')),
    ep: parseInt(urlParams.get('ep')) || 1,
    slug: pathMatch ? pathMatch[1] : null
  };
}

// JSONBin API Functions
async function getData() {
  try {
    const response = await fetch(`${JSONBIN_URL}/latest`, {
      headers: { "X-Master-Key": JSONBIN_KEY }
    });
    const data = await response.json();
    return data.record || [];
  } catch (error) {
    console.error('Error getting data:', error);
    themeManager.showToast('Failed to load anime data', 'error');
    return [];
  }
}

// Text utilities
function truncateText(text, maxLength) {
  if (!text) return 'No description available';
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

// Watch Page Controller
class WatchController {
  constructor() {
    this.videoPlayer = document.getElementById('videoPlayer');
    this.episodesEl = document.getElementById('episodes');
    this.prevBtn = document.getElementById('prevEp');
    this.nextBtn = document.getElementById('nextEp');
    this.animeTitleEl = document.getElementById('animeTitle');
    this.nowPlayingEl = document.getElementById('nowPlaying');
    this.animeDetailsEl = document.getElementById('animeDetails');
    this.episodeCountEl = document.getElementById('episodeCount');
    
    this.currentAnime = null;
    this.currentEpisodeIndex = 0;

    if (this.videoPlayer && this.episodesEl) {
      this.init();
    }
  }

  async init() {
    // Load anime data from JSONBin
    animeData = await getData();
    
    this.bindEvents();
    await this.loadAnimeData();
  }

  async loadAnimeData() {
    const params = parseUrlParams();
    let animeId = params.id;
    let episodeNum = params.ep;

    // Fallback: try to get from sessionStorage
    if (!animeId || isNaN(animeId)) {
      animeId = parseInt(sessionStorage.getItem('current_anime_id'));
      episodeNum = parseInt(sessionStorage.getItem('current_episode')) || 1;
    }

    if (!animeId || isNaN(animeId)) {
      this.showError('Anime not found. Please select an anime from the home page.');
      return;
    }
    
    this.currentAnime = animeData.find(a => a.id === animeId);
    this.currentEpisodeIndex = Math.max(0, episodeNum - 1);

    if (!this.currentAnime) {
      this.showError('Anime not found in database.');
      return;
    }

    if (!this.currentAnime.episodes || this.currentAnime.episodes.length === 0) {
      this.showError('No episodes available for this anime.');
      return;
    }

    this.renderAnimeDetails();
    this.renderEpisodeList();
    this.loadEpisode(this.currentEpisodeIndex);
    this.updateMetaTags();
    this.updateBreadcrumb();
    this.loadRelatedAnime();
  }

  updateMetaTags() {
    if (!this.currentAnime) return;

    const episode = this.currentAnime.episodes[this.currentEpisodeIndex];
    const episodeTitle = episode ? (episode.title || `Episode ${episode.num}`) : 'Episode';
    
    // Update page title
    const pageTitle = `Watch ${this.currentAnime.title} ${episodeTitle} - DongTube`;
    document.title = pageTitle;
    document.getElementById('pageTitle').textContent = pageTitle;
    
    // Update meta description
    const description = `Watch ${this.currentAnime.title} ${episodeTitle} in HD quality with subtitles. ${truncateText(this.currentAnime.description, 100)}`;
    document.getElementById('pageDescription').setAttribute('content', description);
    
    // Update Open Graph tags
    document.getElementById('ogTitle').setAttribute('content', pageTitle);
    document.getElementById('ogDescription').setAttribute('content', description);
    document.getElementById('ogImage').setAttribute('content', this.currentAnime.thumb || '');
    document.getElementById('ogUrl').setAttribute('content', window.location.href);
  }

  updateBreadcrumb() {
    if (!this.currentAnime) return;

    const truncatedTitle = this.currentAnime.title.length > 30 
      ? this.currentAnime.title.substring(0, 30) + '...' 
      : this.currentAnime.title;
    
    document.getElementById('animeBreadcrumb').textContent = truncatedTitle;
    document.getElementById('animeBreadcrumb').href = `/home?search=${encodeURIComponent(this.currentAnime.title)}`;
    
    const episode = this.currentAnime.episodes[this.currentEpisodeIndex];
    const episodeTitle = episode ? (episode.title || `Episode ${episode.num}`) : 'Episode';
    const truncatedEpisode = episodeTitle.length > 25 
      ? episodeTitle.substring(0, 25) + '...'
      : episodeTitle;
    
    document.getElementById('episodeBreadcrumb').textContent = truncatedEpisode;
  }

  renderAnimeDetails() {
    if (!this.currentAnime || !this.animeDetailsEl) return;

    // Update page title
    if (this.animeTitleEl) {
      const truncatedTitle = this.currentAnime.title.length > 40 
        ? this.currentAnime.title.substring(0, 40) + '...'
        : this.currentAnime.title;
      this.animeTitleEl.textContent = truncatedTitle;
    }

    // Update episode counter
    if (this.episodeCountEl) {
      this.episodeCountEl.textContent = `(${this.currentAnime.episodes.length})`;
    }

    // Render details
    const statusClass = this.currentAnime.status.toLowerCase() === 'ongoing' ? 'status-ongoing' : 'status-complete';
    
    this.animeDetailsEl.innerHTML = `
      <div class="anime-poster">
        <img src="${this.currentAnime.thumb}" alt="${this.currentAnime.title}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOWNhM2FmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'">
      </div>
      <div class="anime-info">
        <div class="anime-title">${this.currentAnime.title}</div>
        <div class="anime-status">
          <span class="status-badge ${statusClass}">${this.currentAnime.status}</span>
        </div>
        <div class="anime-meta-grid">
          ${this.currentAnime.year ? `<div class="meta-item"><span class="meta-label">Year:</span> ${this.currentAnime.year}</div>` : ''}
          ${this.currentAnime.genre ? `<div class="meta-item"><span class="meta-label">Genre:</span> ${truncateText(this.currentAnime.genre, 20)}</div>` : ''}
          ${this.currentAnime.rating ? `<div class="meta-item"><span class="meta-label">Rating:</span> ‚≠ê ${this.currentAnime.rating}/10</div>` : ''}
        </div>
        ${this.currentAnime.description ? `<div class="anime-description">${truncateText(this.currentAnime.description, 120)}</div>` : ''}
      </div>
    `;
  }

  renderEpisodeList() {
    if (!this.currentAnime || !this.episodesEl) return;

    this.episodesEl.innerHTML = '';
    
    this.currentAnime.episodes.forEach((episode, index) => {
      const episodeEl = document.createElement('div');
      episodeEl.className = 'episode-item';
      
      const episodeTitle = episode.title 
        ? (episode.title.length > 25 ? episode.title.substring(0, 25) + '...' : episode.title)
        : `Episode ${episode.num}`;
      
      episodeEl.innerHTML = `
        <div class="episode-number">EP ${episode.num}</div>
        <div class="episode-title">${episodeTitle}</div>
      `;
      
      episodeEl.addEventListener('click', () => this.loadEpisode(index));
      this.episodesEl.appendChild(episodeEl);
    });
  }

  loadEpisode(index) {
    if (!this.currentAnime || index < 0 || index >= this.currentAnime.episodes.length) return;

    this.currentEpisodeIndex = index;
    const episode = this.currentAnime.episodes[index];
    
    // Show loading
    this.showPlayerLoading();
    
    // Update video source after delay
    setTimeout(() => {
      if (this.videoPlayer) {
        this.videoPlayer.src = episode.src;
      }
      
      // Update now playing
      if (this.nowPlayingEl) {
        const title = episode.title || `Episode ${episode.num}`;
        const truncatedTitle = title.length > 40 ? title.substring(0, 40) + '...' : title;
        this.nowPlayingEl.textContent = truncatedTitle;
      }
      
      // Update active episode
      this.updateActiveEpisode();
      
      // Update navigation buttons
      this.updateNavigationButtons();
      
      // Update URL and meta tags
      this.updateURL();
      this.updateMetaTags();
      this.updateBreadcrumb();
      
      // Hide loading
      this.hidePlayerLoading();
      
      // Scroll to player smoothly
      this.videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
    }, 1000);
  }

  updateActiveEpisode() {
    document.querySelectorAll('.episode-item').forEach((el, index) => {
      el.classList.toggle('active', index === this.currentEpisodeIndex);
    });
  }

  updateNavigationButtons() {
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentEpisodeIndex <= 0;
      this.prevBtn.style.opacity = this.currentEpisodeIndex <= 0 ? '0.5' : '1';
    }
    
    if (this.nextBtn) {
      this.nextBtn.disabled = this.currentEpisodeIndex >= this.currentAnime.episodes.length - 1;
      this.nextBtn.style.opacity = this.currentEpisodeIndex >= this.currentAnime.episodes.length - 1 ? '0.5' : '1';
    }
  }

  updateURL() {
    const newURL = `${createStreamingUrl(this.currentAnime)}?id=${this.currentAnime.id}&ep=${this.currentEpisodeIndex + 1}`;
    
    window.history.pushState({
      animeId: this.currentAnime.id,
      episodeNum: this.currentEpisodeIndex + 1
    }, '', newURL);
  }

  showPlayerLoading() {
    const loading = document.getElementById('playerLoading');
    if (loading) {
      loading.style.display = 'flex';
    }
  }

  hidePlayerLoading() {
    const loading = document.getElementById('playerLoading');
    if (loading) {
      loading.style.display = 'none';
    }
  }

  loadRelatedAnime() {
    if (!this.currentAnime) return;

    const relatedContainer = document.getElementById('relatedAnime');
    if (!relatedContainer) return;

    // Find related anime by genre or status
    const related = animeData
      .filter(anime => anime.id !== this.currentAnime.id)
      .filter(anime => {
        if (this.currentAnime.genre && anime.genre) {
          const currentGenres = this.currentAnime.genre.toLowerCase().split(',').map(g => g.trim());
          const animeGenres = anime.genre.toLowerCase().split(',').map(g => g.trim());
          return currentGenres.some(genre => animeGenres.includes(genre));
        }
        return anime.status === this.currentAnime.status;
      })
      .slice(0, 4);

    if (related.length === 0) {
      document.querySelector('.related-section').style.display = 'none';
      return;
    }

    relatedContainer.innerHTML = related.map(anime => {
      const statusClass = anime.status.toLowerCase() === 'ongoing' ? 'status-ongoing' : 'status-complete';
      const truncatedTitle = anime.title.length > 30 ? anime.title.substring(0, 30) + '...' : anime.title;
      
      return `
        <a href="/streaming-${anime.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-')}?id=${anime.id}&ep=1" class="related-card">
          <img src="${anime.thumb}" alt="${anime.title}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOWNhM2FmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'" class="related-image">
          <div class="related-info">
            <div class="related-title">${truncatedTitle}</div>
            <span class="status-badge ${statusClass}">${anime.status}</span>
          </div>
        </a>
      `;
    }).join('');
  }

  bindEvents() {
    // Navigation buttons
    if (this.prevBtn) {
      this.prevBtn.addEventListener('click', () => {
        if (this.currentEpisodeIndex > 0) {
          this.loadEpisode(this.currentEpisodeIndex - 1);
        }
      });
    }

    if (this.nextBtn) {
      this.nextBtn.addEventListener('click', () => {
        if (this.currentEpisodeIndex < this.currentAnime.episodes.length - 1) {
          this.loadEpisode(this.currentEpisodeIndex + 1);
        }
      });
    }

    // Control buttons
    const favoriteBtn = document.getElementById('favoriteBtn');
    const shareBtn = document.getElementById('shareBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    if (favoriteBtn) {
      favoriteBtn.addEventListener('click', () => {
        favoriteBtn.classList.toggle('active');
        const isActive = favoriteBtn.classList.contains('active');
        
        this.toggleFavorite(isActive);
        
        themeManager.showToast(isActive ? 'Added to favorites' : 'Removed from favorites', 'success');
      });
      
      // Check initial favorite status
      this.checkFavoriteStatus();
    }

    if (shareBtn) {
      shareBtn.addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: `${this.currentAnime.title} - Episode ${this.currentEpisodeIndex + 1}`,
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(window.location.href).then(() => {
            themeManager.showToast('Link copied to clipboard', 'success');
          });
        }
      });
    }

    if (fullscreenBtn) {
      fullscreenBtn.addEventListener('click', () => {
        if (this.videoPlayer.requestFullscreen) {
          this.videoPlayer.requestFullscreen();
        } else if (this.videoPlayer.webkitRequestFullscreen) {
          this.videoPlayer.webkitRequestFullscreen();
        } else if (this.videoPlayer.mozRequestFullScreen) {
          this.videoPlayer.mozRequestFullScreen();
        }
      });
    }

    // Keyboard shortcuts
    this.bindKeyboardShortcuts();
  }

  toggleFavorite(isActive) {
    if (!this.currentAnime) return;
    
    let favorites = JSON.parse(localStorage.getItem('dongtube_favorites') || '[]');
    
    if (isActive) {
      if (!favorites.includes(this.currentAnime.id)) {
        favorites.push(this.currentAnime.id);
      }
    } else {
      favorites = favorites.filter(id => id !== this.currentAnime.id);
    }
    
    localStorage.setItem('dongtube_favorites', JSON.stringify(favorites));
  }

  checkFavoriteStatus() {
    if (!this.currentAnime) return;
    
    const favorites = JSON.parse(localStorage.getItem('dongtube_favorites') || '[]');
    const favoriteBtn = document.getElementById('favoriteBtn');
    
    if (favoriteBtn && favorites.includes(this.currentAnime.id)) {
      favoriteBtn.classList.add('active');
    }
  }

  bindKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Don't trigger if user is typing
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          if (this.currentEpisodeIndex > 0) {
            this.loadEpisode(this.currentEpisodeIndex - 1);
          }
          break;
        case 'ArrowRight':
          e.preventDefault();
          if (this.currentEpisodeIndex < this.currentAnime.episodes.length - 1) {
            this.loadEpisode(this.currentEpisodeIndex + 1);
          }
          break;
        case 'f':
          e.preventDefault();
          document.getElementById('fullscreenBtn')?.click();
          break;
      }
    });
  }

  showError(message) {
    themeManager.showToast(message, 'error');
    
    // Show error in main content
    const container = document.querySelector('.container');
    if (container) {
      container.innerHTML = `
        <div class="error-state">
          <div class="error-icon">üòû</div>
          <h2>Oops! Something went wrong</h2>
          <p>${message}</p>
          <a href="/home" class="btn">Go Back Home</a>
        </div>
      `;
    }
  }
}

// Initialize Application
let themeManager;
let watchController;

// Handle browser back/forward navigation
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.animeId) {
    location.reload();
  }
});

document.addEventListener('DOMContentLoaded', () => {
  // Initialize theme manager
  themeManager = new ThemeManager();
  
  // Initialize watch controller
  watchController = new WatchController();
});
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="pageTitle">Watch Anime - DongTube</title>
<link rel="icon" type="image/png" href="https://b.top4top.io/p_35449hn0x0.jpg">
<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<meta name="description" id="pageDescription" content="Watch anime episodes in HD quality with subtitles on DongTube">
<meta property="og:title" id="ogTitle" content="Watch Anime - DongTube">
<meta property="og:description" id="ogDescription" content="Stream anime episodes in HD quality">
<meta property="og:image" id="ogImage" content="">
<meta property="og:url" id="ogUrl" content="">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="watch-page">

<!-- Background Animation -->
<div class="bg-animation">
  <div class="floating-orb orb-1"></div>
  <div class="floating-orb orb-2"></div>
</div>

<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-brand">
      <a href="/" class="brand-link">
        <span class="brand-icon">üé¨</span>
        <span class="brand-text">DongTube</span>
      </a>
    </div>
    <div class="nav-center">
      <h1 id="animeTitle" class="nav-title">Loading...</h1>
    </div>
    <div class="nav-actions">
      <button id="themeSwitcher" class="nav-btn" title="Switch Theme">üåô</button>
    </div>
  </div>
</nav>

<div class="container">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb" id="breadcrumb" style="margin-bottom: 1rem;">
    <a href="/" class="breadcrumb-link">Home</a>
    <span class="breadcrumb-separator">></span>
    <a href="#" id="animeBreadcrumb" class="breadcrumb-link">Anime</a>
    <span class="breadcrumb-separator">></span>
    <span id="episodeBreadcrumb">Episode</span>
  </nav>

  <!-- Now Playing Header -->
  <div class="now-playing">
    <div class="now-playing-info">
      <span class="live-badge">üî¥ WATCHING</span>
      <h2 id="nowPlaying">Episode 1</h2>
    </div>
  </div>

  <!-- Video Player -->
  <div class="player-container">
    <div class="player-wrapper">
      <iframe id="videoPlayer" src="" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
      <div class="player-loading" id="playerLoading">
        <div class="spinner"></div>
        <span>Loading episode...</span>
      </div>
    </div>
    
    <!-- Player Controls -->
    <div class="player-controls">
      <div class="control-left">
        <span class="quality-badge">HD</span>
        <span class="sub-badge">SUB</span>
      </div>
      <div class="control-right">
        <button class="control-btn" id="favoriteBtn" title="Add to Favorites">‚ù§Ô∏è</button>
        <button class="control-btn" id="shareBtn" title="Share">üì§</button>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
      </div>
    </div>
  </div>

  <!-- Main Content Layout -->
  <div class="watch-content">
    
    <!-- Anime Info Sidebar -->
    <div class="anime-info">
      <div class="info-card">
        <div id="animeDetails" class="anime-details">
          <div class="details-loading">
            <div class="skeleton-img"></div>
            <div class="skeleton-text"></div>
            <div class="skeleton-text short"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Episodes Section -->
    <div class="episodes-section">
      <!-- Episode Navigation -->
      <div class="episode-header">
        <h3 class="section-title">Episodes <span id="episodeCount">(0)</span></h3>
        <div class="episode-nav">
          <button id="prevEp" class="nav-btn">‚èÆÔ∏è Previous</button>
          <button id="nextEp" class="nav-btn">Next ‚è≠Ô∏è</button>
        </div>
      </div>

      <!-- Episode List -->
      <div class="episode-container">
        <div id="episodes" class="episode-list"></div>
      </div>
    </div>
  </div>

  <!-- Related Anime Section -->
  <section class="related-section" style="margin-top: 3rem;">
    <h3 class="section-title">Related Anime</h3>
    <div id="relatedAnime" class="anime-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
  </section>
</div>

<!-- Footer -->
<footer class="footer compact">
  <div class="footer-content">
    <span>&copy; 2025 DongTube</span>
    <a href="/" class="back-link">‚Üê Back to Home</a>
  </div>
</footer>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<script>
// JSONBin Configuration
const JSONBIN_URL = "https://api.jsonbin.io/v3/b/68c7fdc9d0ea881f407e85cc";
const JSONBIN_KEY = "$2a$10$PsVzgljojE5fq8qZRmpE4uzMr0K9LArqfmumGVSmNY.P8F2iTKrim";

// Global variables
let animeData = [];
let currentAnime = null;
let currentEpisodeIndex = 0;

// Theme Management (same as homepage)
class ThemeManager {
  constructor() {
    this.currentTheme = localStorage.getItem('dongtube_theme') || 'dark';
    this.init();
  }

  init() {
    this.applyTheme(this.currentTheme);
    this.bindEvents();
  }

  applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const themeIcon = document.querySelector('#themeSwitcher');
    if (themeIcon) {
      themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    this.currentTheme = theme;
    localStorage.setItem('dongtube_theme', theme);
  }

  toggle() {
    const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
    this.applyTheme(newTheme);
    this.showToast(`Switched to ${newTheme} theme`, 'success');
  }

  bindEvents() {
    const themeSwitcher = document.getElementById('themeSwitcher');
    if (themeSwitcher) {
      themeSwitcher.addEventListener('click', () => this.toggle());
    }
  }

  showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') || this.createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 300);
    }, 3000);
  }

  createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
    return container;
  }
}

// URL Helper Functions
function createSEOUrl(anime, episode) {
  const baseUrl = window.location.origin;
  let slug = anime.title
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
  
  const episodeSlug = episode.title
    ? episode.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-')
    : `episode-${episode.num}`;
  
  return `${baseUrl}/home/streaming-${slug}-${episodeSlug}`;
}

function parseUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    id: parseInt(urlParams.get('id')),
    ep: parseInt(urlParams.get('ep')) || 1
  };
}

// JSONBin API Functions
async function getData() {
  try {
    const response = await fetch(`${JSONBIN_URL}/latest`, {
      headers: { "X-Master-Key": JSONBIN_KEY }
    });
    const data = await response.json();
    return data.record || [];
  } catch (error) {
    console.error('Error getting data:', error);
    themeManager.showToast('Failed to load anime data', 'error');
    return [];
  }
}

// Watch Page Controller
class WatchController {
  constructor() {
    this.videoPlayer = document.getElementById('videoPlayer');
    this.episodesEl = document.getElementById('episodes');
    this.prevBtn = document.getElementById('prevEp');
    this.nextBtn = document.getElementById('nextEp');
    this.animeTitleEl = document.getElementById('animeTitle');
    this.nowPlayingEl = document.getElementById('nowPlaying');
    this.animeDetailsEl = document.getElementById('animeDetails');
    this.episodeCountEl = document.getElementById('episodeCount');
    
    this.currentAnime = null;
    this.currentEpisodeIndex = 0;

    if (this.videoPlayer && this.episodesEl) {
      this.init();
    }
  }

  async init() {
    // Load anime data from JSONBin
    animeData = await getData();
    
    this.bindEvents();
    await this.loadAnimeData();
  }

  async loadAnimeData() {
    const params = parseUrlParams();
    let animeId = params.id;
    let episodeNum = params.ep;

    // Fallback: try to get from sessionStorage
    if (!animeId || isNaN(animeId)) {
      animeId = parseInt(sessionStorage.getItem('current_anime_id'));
      episodeNum = parseInt(sessionStorage.getItem('current_episode')) || 1;
    }

    if (!animeId || isNaN(animeId)) {
      this.showError('Anime not found');
      return;
    }
    
    this.currentAnime = animeData.find(a => a.id === animeId);
    this.currentEpisodeIndex = Math.max(0, episodeNum - 1);

    if (!this.currentAnime) {
      this.showError('Anime not found');
      return;
    }

    if (!this.currentAnime.episodes || this.currentAnime.episodes.length === 0) {
      this.showError('No episodes available');
      return;
    }

    this.renderAnimeDetails();
    this.renderEpisodeList();
    this.loadEpisode(this.currentEpisodeIndex);
    this.updateMetaTags();
    this.updateBreadcrumb();
    this.loadRelatedAnime();
  }

  updateMetaTags() {
    if (!this.currentAnime) return;

    const episode = this.currentAnime.episodes[this.currentEpisodeIndex];
    const episodeTitle = episode ? episode.title || `Episode ${episode.num}` : 'Episode';
    
    // Update page title
    document.title = `Watch ${this.currentAnime.title} ${episodeTitle} - DongTube`;
    document.getElementById('pageTitle').textContent = document.title;
    
    // Update meta description
    const description = `Watch ${this.currentAnime.title} ${episodeTitle} in HD quality with subtitles. ${this.currentAnime.description || ''}`.substring(0, 160);
    document.getElementById('pageDescription').setAttribute('content', description);
    
    // Update Open Graph tags
    document.getElementById('ogTitle').setAttribute('content', document.title);
    document.getElementById('ogDescription').setAttribute('content', description);
    document.getElementById('ogImage').setAttribute('content', this.currentAnime.thumb || '');
    document.getElementById('ogUrl').setAttribute('content', window.location.href);
  }

  updateBreadcrumb() {
    if (!this.currentAnime) return;

    document.getElementById('animeBreadcrumb').textContent = this.currentAnime.title;
    document.getElementById('animeBreadcrumb').href = `/?search=${encodeURIComponent(this.currentAnime.title)}`;
    
    const episode = this.currentAnime.episodes[this.currentEpisodeIndex];
    const episodeTitle = episode ? (episode.title || `Episode ${episode.num}`) : 'Episode';
    document.getElementById('episodeBreadcrumb').textContent = episodeTitle;
  }

  renderAnimeDetails() {
    if (!this.currentAnime || !this.animeDetailsEl) return;

    // Update page title
    if (this.animeTitleEl) {
      this.animeTitleEl.textContent = this.currentAnime.title;
    }

    // Update episode counter
    if (this.episodeCountEl) {
      this.episodeCountEl.textContent = `(${this.currentAnime.episodes.length})`;
    }

    // Render details
    const statusClass = this.currentAnime.status.toLowerCase() === 'ongoing' ? 'status-ongoing' : 'status-complete';
    
    this.animeDetailsEl.innerHTML = `
      <img src="${this.currentAnime.thumb}" alt="${this.currentAnime.title}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOWNhM2FmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'">
      <div class="title">${this.currentAnime.title}</div>
      <div class="status">
        <span class="status-badge ${statusClass}">${this.currentAnime.status}</span>
      </div>
      ${this.currentAnime.genre ? `<div class="genre">üìÇ ${this.currentAnime.genre}</div>` : ''}
      ${this.currentAnime.year ? `<div class="year">üìÖ ${this.currentAnime.year}</div>` : ''}
      ${this.currentAnime.rating ? `<div class="rating">‚≠ê ${this.currentAnime.rating}/10</div>` : ''}
      ${this.currentAnime.description ? `<div class="description">${this.currentAnime.description}</div>` : ''}
    `;
  }

  renderEpisodeList() {
    if (!this.currentAnime || !this.episodesEl) return;

    this.episodesEl.innerHTML = '';
    
    this.currentAnime.episodes.forEach((episode, index) => {
      const episodeEl = document.createElement('div');
      episodeEl.className = 'episode';
      episodeEl.innerHTML = `
        <div class="ep-number">EP ${episode.num}</div>
        ${episode.title ? `<div class="ep-title">${episode.title}</div>` : ''}
      `;
      
      episodeEl.addEventListener('click', () => this.loadEpisode(index));
      this.episodesEl.appendChild(episodeEl);
    });
  }

  loadEpisode(index) {
    if (!this.currentAnime || index < 0 || index >= this.currentAnime.episodes.length) return;

    this.currentEpisodeIndex = index;
    const episode = this.currentAnime.episodes[index];
    
    // Show loading
    this.showPlayerLoading();
    
    // Update video source after delay
    setTimeout(() => {
      if (this.videoPlayer) {
        this.videoPlayer.src = episode.src;
      }
      
      // Update now playing
      if (this.nowPlayingEl) {
        const title = episode.title || `Episode ${episode.num}`;
        this.nowPlayingEl.textContent = title;
      }
      
      // Update active episode
      this.updateActiveEpisode();
      
      // Update navigation buttons
      this.updateNavigationButtons();
      
      // Update URL and meta tags
      this.updateURL();
      this.updateMetaTags();
      this.updateBreadcrumb();
      
      // Hide loading
      this.hidePlayerLoading();
      
      // Scroll to player
      this.videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // Track view (optional analytics)
      this.trackView();
      
    }, 1000);
  }

  updateActiveEpisode() {
    document.querySelectorAll('.episode').forEach((el, index) => {
      el.classList.toggle('active', index === this.currentEpisodeIndex);
    });
  }

  updateNavigationButtons() {
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentEpisodeIndex <= 0;
    }
    
    if (this.nextBtn) {
      this.nextBtn.disabled = this.currentEpisodeIndex >= this.currentAnime.episodes.length - 1;
    }
  }

  updateURL() {
    const episode = this.currentAnime.episodes[this.currentEpisodeIndex];
    const newURL = createSEOUrl(this.currentAnime, episode);
    const searchParams = `?id=${this.currentAnime.id}&ep=${this.currentEpisodeIndex + 1}`;
    
    // Update URL without page refresh
    window.history.pushState({
      animeId: this.currentAnime.id,
      episodeNum: this.currentEpisodeIndex + 1
    }, '', `${newURL}${searchParams}`);
  }

  showPlayerLoading() {
    const loading = document.getElementById('playerLoading');
    if (loading) {
      loading.style.display = 'flex';
    }
  }

  hidePlayerLoading() {
    const loading = document.getElementById('playerLoading');
    if (loading) {
      loading.style.display = 'none';
    }
  }

  loadRelatedAnime() {
    if (!this.currentAnime) return;

    const relatedContainer = document.getElementById('relatedAnime');
    if (!relatedContainer) return;

    // Find related anime by genre or status
    const related = animeData
      .filter(anime => anime.id !== this.currentAnime.id)
      .filter(anime => {
        if (this.currentAnime.genre && anime.genre) {
          const currentGenres = this.currentAnime.genre.toLowerCase().split(',').map(g => g.trim());
          const animeGenres = anime.genre.toLowerCase().split(',').map(g => g.trim());
          return currentGenres.some(genre => animeGenres.includes(genre));
        }
        return anime.status === this.currentAnime.status;
      })
      .slice(0, 6);

    if (related.length === 0) {
      relatedContainer.style.display = 'none';
      return;
    }

    relatedContainer.innerHTML = related.map(anime => {
      const statusClass = anime.status.toLowerCase() === 'ongoing' ? 'status-ongoing' : 'status-complete';
      return `
        <a href="?id=${anime.id}&ep=1" class="card" onclick="location.reload()">
          <img src="${anime.thumb}" alt="${anime.title}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNHB4IiBmaWxsPSIjOWNhM2FmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'">
          <div class="info">
            <div class="title">${anime.title}</div>
            <div class="status">
              <span class="status-badge ${statusClass}">${anime.status}</span>
            </div>
          </div>
        </a>
      `;
    }).join('');
  }

  bindEvents() {
    // Navigation buttons
    if (this.prevBtn) {
      this.prevBtn.addEventListener('click', () => {
        if (this.currentEpisodeIndex > 0) {
          this.loadEpisode(this.currentEpisodeIndex - 1);
        }
      });
    }

    if (this.nextBtn) {
      this.nextBtn.addEventListener('click', () => {
        if (this.currentEpisodeIndex < this.currentAnime.episodes.length - 1) {
          this.loadEpisode(this.currentEpisodeIndex + 1);
        }
      });
    }

    // Control buttons
    const favoriteBtn = document.getElementById('favoriteBtn');
    const shareBtn = document.getElementById('shareBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    if (favoriteBtn) {
      favoriteBtn.addEventListener('click', () => {
        favoriteBtn.classList.toggle('active');
        const isActive = favoriteBtn.classList.contains('active');
        
        // Save to favorites in localStorage
        this.toggleFavorite(isActive);
        
        themeManager.showToast(isActive ? 'Added to favorites' : 'Removed from favorites', 'success');
      });
    }

    if (shareBtn) {
      shareBtn.addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({
            title: `${this.currentAnime.title} - Episode ${this.currentEpisodeIndex + 1}`,
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(window.location.href).then(() => {
            themeManager.showToast('Link copied to clipboard', 'success');
          });
        }
      });
    }

    if (fullscreenBtn) {
      fullscreenBtn.addEventListener('click', () => {
        if (this.videoPlayer.requestFullscreen) {
          this.videoPlayer.requestFullscreen();
        } else if (this.videoPlayer.webkitRequestFullscreen) {
          this.videoPlayer.webkitRequestFullscreen();
        } else if (this.videoPlayer.mozRequestFullScreen) {
          this.videoPlayer.mozRequestFullScreen();
        }
      });
    }

    // Keyboard shortcuts
    this.bindKeyboardShortcuts();
  }

  toggleFavorite(isActive) {
    if (!this.currentAnime) return;
    
    let favorites = JSON.parse(localStorage.getItem('dongtube_favorites') || '[]');
    
    if (isActive) {
      if (!favorites.includes(this.currentAnime.id)) {
        favorites.push(this.currentAnime.id);
      }
    } else {
      favorites = favorites.filter(id => id !== this.currentAnime.id);
    }
    
    localStorage.setItem('dongtube_favorites', JSON.stringify(favorites));
  }

  checkFavoriteStatus() {
    if (!this.currentAnime) return;
    
    const favorites = JSON.parse(localStorage.getItem('dongtube_favorites') || '[]');
    const favoriteBtn = document.getElementById('favoriteBtn');
    
    if (favoriteBtn && favorites.includes(this.currentAnime.id)) {
      favoriteBtn.classList.add('active');
    }
  }

  bindKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      // Don't trigger if user is typing
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.key) {
        case 'ArrowLeft':
          e.preventDefault();
          if (this.currentEpisodeIndex > 0) {
            this.loadEpisode(this.currentEpisodeIndex - 1);
          }
          break;
        case 'ArrowRight':
          e.preventDefault();
          if (this.currentEpisodeIndex < this.currentAnime.episodes.length - 1) {
            this.loadEpisode(this.currentEpisodeIndex + 1);
          }
          break;
        case ' ':
          e.preventDefault();
          // Toggle play/pause (if supported by iframe)
          break;
        case 'f':
          e.preventDefault();
          document.getElementById('fullscreenBtn')?.click();
          break;
      }
    });
  }

  trackView() {
    // Optional: Send analytics data
    // This is where you'd integrate with Google Analytics, etc.
    console.log('Viewing:', this.currentAnime.title, 'Episode', this.currentEpisodeIndex + 1);
  }

  showError(message) {
    themeManager.showToast(message, 'error');
    setTimeout(() => {
      window.location.href = '/';
    }, 3000);
  }
}

// Initialize Application
let themeManager;
let watchController;

// Handle browser back/forward navigation
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.animeId) {
    location.reload(); // Simple reload for now
  }
});

document.addEventListener('DOMContentLoaded', () => {
  // Initialize theme manager
  themeManager = new ThemeManager();
  
  // Initialize watch controller
  watchController = new WatchController();
});
</script>

<style>
/* Additional styles for watch page */
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.breadcrumb-link {
  color: var(--accent);
  text-decoration: none;
  transition: var(--transition);
}

.breadcrumb-link:hover {
  color: var(--accent2);
  text-decoration: underline;
}

.breadcrumb-separator {
  color: var(--text-muted);
}

.related-section {
  margin-top: 3rem;
}

.related-section .section-title {
  margin-bottom: 1.5rem;
}

@media (max-width: 768px) {
  .breadcrumb {
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
  }
  
  .related-section {
    margin-top: 2rem;
  }
  
  .related-section .anime-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
}
</style>
</body>
</html>